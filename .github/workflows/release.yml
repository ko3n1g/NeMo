name: "Release"

on:
  pull_request:
    types: [closed]
    branches: 
      - main

jobs: 
  main:
    if: startsWith(github.event.pull_request.head.ref, 'release/')
    runs-on: ubuntu-latest
    steps:
      - name: Get version number
        id: version-number
        run: |
          VERSION=$(echo ${{ github.event.pull_request.head.ref }} | sed 's/^release\///')
          echo "VERSION=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Extract changelog
        id: extract-changelog
        uses: peter-evans/find-comment@v3
        with:
          issue-number: ${{ github.event.number }}
          body-includes: |
            Changelog:
            -----------
      
      - name: Extract summary
        id: extract-summary
        uses: peter-evans/find-comment@v3
        with:
          issue-number: ${{ github.event.number }}
          body-includes: |
            Summary:
            -----------
        
      - name: Create Release doc
        id: create-release-doc
        run: |
          CHANGELOG=$(echo "${{ steps.extract-changelog.outputs.comment-body }}" | sed '/Changelog:/d' | sed '/^-----------$/d')
          SUMMARY=$(echo "${{ steps.extract-summary.outputs.comment-body }}" | sed '/Summary:/d' | sed '/^-----------$/d') 
          
          TITLE="NVIDIA Neural Modules ${{ steps.version-number.outputs.VERSION }}"
          read -r -d '' BODY <<- EOM
          # Highlights
          $SUMMARY

          # Detailed Changelogs
          $CHANGELOG
          EOM

          echo "TITLE<<EOF" >> $GITHUB_ENV
          echo "$TITLE" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

          echo "BODY<<EOF" >> $GITHUB_ENV
          echo "$BODY" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          name: ${{ env.TITLE }}
          tag_name: ${{ steps.version-number.outputs.VERSION }}
          body: ${{ env.BODY }}
          